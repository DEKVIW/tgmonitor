# 🔗 链接检测功能使用说明

## 📋 功能概述

链接检测系统可以检测数据库中各种网盘链接的有效性，支持多种检测方式、时间段选择、中断恢复、详细统计报告和数据管理功能。

### 🛡️ 安全特性

- **网盘特定限制**: 不同网盘使用不同的并发数和延迟策略
- **错误计数保护**: 自动暂停错误过多的网盘检测
- **随机延迟**: 避免被识别为机器人
- **用户确认**: 大规模检测前需要用户确认
- **安全中断**: 支持 Ctrl+C 安全中断并保存结果

---

## 🚀 快速开始

### 5 分钟快速上手

```bash
# 1. 首次使用 - 小规模测试
python manage.py --check-links 1 3

# 2. 扩大范围 - 检测最近24小时
python manage.py --check-links 24 5

# 3. 查看结果
python manage.py --link-stats
python manage.py --show-invalid-links
```

---

## 📊 核心检测命令

### 基础检测命令

```bash
# 检测最近N小时的链接
python manage.py --check-links                    # 最近24小时 (默认5并发)
python manage.py --check-links 48                 # 最近48小时
python manage.py --check-links 24 10              # 最近24小时，10并发

# 检测所有历史链接
python manage.py --check-all-links                # 默认5并发
python manage.py --check-all-links 10             # 10并发
```

### 时间段检测命令

```bash
# 预定义时间段
python manage.py --check-period today             # 今天
python manage.py --check-period yesterday         # 昨天
python manage.py --check-period week              # 最近7天
python manage.py --check-period month             # 最近30天
python manage.py --check-period year              # 最近365天

# 指定时间检测
python manage.py --check-period 2024-01-15        # 指定日期
python manage.py --check-period 2024-01           # 指定月份
python manage.py --check-period 2024              # 指定年份
python manage.py --check-period 2024-01-15:2024-01-20  # 指定日期范围

# 自定义并发数
python manage.py --check-period today 10          # 今天，10并发
python manage.py --check-period week 5            # 最近7天，5并发
```

---

## 📈 统计查看命令

```bash
# 查看检测统计
python manage.py --link-stats

# 查看失效链接详情
python manage.py --show-invalid-links             # 最近的失效链接
python manage.py --show-invalid-links "2024-01-15T14:30:00"  # 指定时间
python manage.py --show-invalid-links 50          # 最近50个

# 查看中断记录
python manage.py --show-interrupted
```

---

## 🗑️ 数据管理命令

```bash
# 清空所有检测数据 (需要确认)
python manage.py --clear-link-check-data

# 清空旧数据
python manage.py --clear-old-link-check-data      # 30天前 (默认)
python manage.py --clear-old-link-check-data 7    # 7天前
python manage.py --clear-old-link-check-data 60   # 60天前
```

---

## 📊 网盘支持与限制

| 网盘类型 | 最大并发 | 延迟范围 | 域名           |
| -------- | -------- | -------- | -------------- |
| 百度网盘 | 3        | 1-3 秒   | pan.baidu.com  |
| 夸克网盘 | 5        | 0.5-2 秒 | pan.quark.cn   |
| 阿里云盘 | 4        | 1-2.5 秒 | www.alipan.com |
| 115 网盘 | 2        | 2-4 秒   | 115.com        |
| 天翼云盘 | 3        | 1-3 秒   | cloud.189.cn   |
| 123 云盘 | 3        | 1-2 秒   | www.123pan.com |
| UC 网盘  | 3        | 1-2 秒   | drive.uc.cn    |
| 迅雷网盘 | 3        | 1-2 秒   | pan.xunlei.com |

### 安全限制

- **单次检测最大链接数**: 1000 个
- **全局最大并发数**: 10 个
- **全量检测最大并发**: 3 个
- **每个网盘最大错误数**: 10 个

---

## 🎯 使用场景与策略

### 日常监控

```bash
python manage.py --check-period today 10          # 每天检测今天的数据
# 预计时间：5-15分钟
```

### 周报分析

```bash
python manage.py --check-period week 10           # 检测本周数据
# 预计时间：30分钟-1小时
```

### 月度统计

```bash
python manage.py --check-period month 10          # 检测本月数据
# 预计时间：1-2小时
```

### 大规模检测

```bash
python manage.py --check-all-links 10             # 检测所有历史链接
# 预计时间：1-3小时 (取决于链接数量)
```

### 分批检测策略

```bash
# 第1步：检测最近7天
python manage.py --check-period week 10

# 第2步：检测最近30天
python manage.py --check-period month 10

# 第3步：检测历史数据
python manage.py --check-all-links 10
```

---

## ⚠️ 安全警告

检测前会显示的安全警告：

```
🚨 链接检测安全警告
============================================================
📊 检测规模:
   - 链接数量: 500
   - 最大并发: 5
   - 预计耗时: 3.3 - 6.7 分钟

⚠️  风险提示:
   - 高频率请求可能触发网盘反爬虫机制
   - 可能导致IP被临时限制访问
   - 建议在非高峰期进行大规模检测

🛡️  安全措施:
   - 已启用网盘特定的请求限制
   - 随机延迟避免被识别为机器人
   - 错误计数保护机制
   - 支持 Ctrl+C 安全中断

💡 建议:
   - 首次检测建议使用较小的并发数 (3-5)
   - 观察检测结果后再调整参数
   - 如遇到大量错误，请降低并发数或暂停检测
```

---

## 🔧 故障排除

### 常见问题

**Q: 检测速度很慢**
A: 这是正常的，延迟机制确保安全，不要随意提高并发数

**Q: 某个网盘一直失败**
A: 该网盘可能已达到错误限制，等待一段时间后重试

**Q: 检测过程中出现大量错误**
A: 降低并发数，检查网络连接，确认网盘服务正常

**Q: 检测被中断**
A: 使用 `--show-interrupted` 查看记录，重新运行

### 错误处理

- **网络超时**: 自动重试，增加错误计数
- **HTTP 错误**: 记录状态码，增加错误计数
- **网盘限制**: 自动暂停该网盘检测
- **用户中断**: 安全保存已完成结果

---

## 📋 性能参考

### 基于不同并发数的检测时间

| 链接数量 | 5 并发     | 10 并发    | 15 并发    | 20 并发    |
| -------- | ---------- | ---------- | ---------- | ---------- |
| 1,000    | 8-12 分钟  | 4-6 分钟   | 3-4 分钟   | 2-3 分钟   |
| 5,000    | 40-60 分钟 | 20-30 分钟 | 15-20 分钟 | 10-15 分钟 |
| 10,000   | 1.3-2 小时 | 40-60 分钟 | 30-40 分钟 | 20-30 分钟 |

### 并发数设置建议

- **小规模检测** (1000 链接以下)：5-10 并发
- **中等规模检测** (1000-5000 链接)：10-15 并发
- **大规模检测** (5000 链接以上)：15-20 并发

---

## 🗂️ 数据管理策略

### 定期清理策略

```bash
# 每周清理7天前的数据
python manage.py --clear-old-link-check-data 7

# 每月清理30天前的数据
python manage.py --clear-old-link-check-data 30

# 每季度清理90天前的数据
python manage.py --clear-old-link-check-data 90
```

### 数据保留建议

- **最近 7 天** - 保留用于日常监控
- **最近 30 天** - 保留用于月度分析
- **超过 90 天** - 可以安全删除

---

## 🎯 最佳实践

### 安全使用

- ✅ **首次使用从小规模开始**
- ✅ **观察错误率，及时调整并发数**
- ✅ **在非高峰期进行大规模检测**
- ❌ **不要随意提高并发数**
- ❌ **不要在网盘服务高峰期检测**

### 中断处理

- 按 `Ctrl+C` 可以安全中断
- 中断时会自动保存已完成结果
- 可以重新运行命令完成剩余检测

### 数据管理

- **不可恢复** - 清空操作不可撤销
- **谨慎使用** - 建议先备份重要数据
- **定期清理** - 避免数据库过大
- **保留分析** - 建议保留最近 30 天数据

---

## 📞 技术支持

如遇到问题，请检查：

1. 网络连接是否正常
2. 数据库连接是否正常
3. 网盘服务是否可用
4. 安全配置是否合理

**查看帮助**: `python manage.py --help`

---

**注意**: 链接检测功能会向网盘服务器发送请求，请合理使用，避免对网盘服务造成过大压力。
